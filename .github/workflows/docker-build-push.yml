name: Build with Conditional Security Scans

on:
  push:
    branches:
      - main

jobs:
  ###################################################################
  # 1) BUILD JOB
  ###################################################################
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t fafiorim/firefly:latest .

      - name: Save Docker image
        run: docker save fafiorim/firefly:latest -o firefly.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: firefly.tar

  ###################################################################
  # 2) SECURITY SCAN
  ###################################################################
  security-scan:
    if: ${{ vars.SECURITY_ENABLED != 'false' }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download Docker artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: .

      - name: Install Artifact Scan CLI
        run: ./tmas_install.sh

      - name: Set TMAS_API_KEY
        run: echo "TMAS_API_KEY=${{ secrets.TMAS_API_KEY }}" >> $GITHUB_ENV

      - name: Run Full Security Scan
        run: tmas scan docker-archive:firefly.tar -VMS --saveSBOM > scan-results.json

      - name: Upload Scan Results
        uses: actions/upload-artifact@v3
        with:
          name: scan-results
          path: |
            scan-results.json
            SBOM_*.json

  ###################################################################
  # 3) PARSE AND UPLOAD SCAN RESULTS
  ###################################################################
  parse-and-upload-results:
    if: ${{ vars.SECURITY_ENABLED != 'false' }}
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Download Scan Results
        uses: actions/download-artifact@v3
        with:
          name: scan-results
          path: .

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Parse Results
        run: |
          jq '{ vulnerabilities: .vulnerabilities }' scan-results.json > vulnerability-scan-results.json
          jq '{ malware: .malware }' scan-results.json > malware-scan-results.json
          jq '{ secrets: .secrets }' scan-results.json > secret-scan-results.json

      - name: Upload All Results
        uses: actions/upload-artifact@v3
        with:
          name: all-scan-results
          path: |
            vulnerability-scan-results.json
            malware-scan-results.json
            secret-scan-results.json

  ###################################################################
  # 4) PUSH IMAGE
  ###################################################################
  push-image:
    needs: parse-and-upload-results
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download Docker artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: docker load --input firefly.tar

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image
        run: docker push fafiorim/firefly:latest
